# 引导电价/气价与全局最优性分析

## 1. 问题背景与目标
当前系统采用 **plan18（规划/容量）+ 日内调度** 的结构：
- 规划层决定设备选型与容量（整数/连续）。
- 调度层在日内/全年负荷与约束下最小化运行成本。

OJ 评分采用“真实电/气价 + 失负荷惩罚 + 碳超额惩罚”的口径。
我们现在使用的“引导电价/引导气价”是为了使下层调度目标与 OJ 评分目标对齐，从而避免显式双层/逆优化。

本文回答：**使用当前引导电价/气价是否能够得到全局最优解？在什么条件下成立/不成立？**

---

## 2. 数学建模（统一表述）

记：
- 天集合：$\mathcal{D} = \{1,\dots,365\}$，小时集合：$\mathcal{T} = \{1,\dots,24\}$
- 区域集合：$\mathcal{Z} = \{S, F, T\}$（学生区/教工区/教学办公区）
- 规划变量：$y$（plan18，含整数）
- 调度变量：$x_d$（第 $d$ 天的电/热/冷/气/储能/潮流/切负荷等）
- 真实电价/气价：$p^*_e(t), p^*_g(t)$
- 电/气碳因子：$\alpha_e(t), \alpha_g(t)$
- 碳阈值：$E_0$，碳价：$c_{\text{CO2}}$

### 2.1 OJ 评分口径的成本
全年成本（忽略与调度无关的常数）可写为：
\[
\min\; C_{\text{CAP}}(y) + \sum_{d\in\mathcal{D}} C_{\text{OP}}(x_d) + c_{\text{CO2}}\cdot \max(0, E_{\text{year}}(x)-E_0)
\]
其中
\[
C_{\text{OP}}(x_d) = \sum_{t\in\mathcal{T}} \big( p^*_e(t)\,P_e(t) + p^*_g(t)\,P_g(t) + c_{\text{shed}}\,L_{\text{shed}}(t) \big)
\]
\[
E_{\text{year}}(x) = \sum_{t} \big( \alpha_e(t)\,P_e(t) + \alpha_g(t)\,P_g(t) \big)
\]

### 2.2 日内调度（下层）
给定规划 $y$ 与引导价 $p^{\text{guide}}_e(t), p^{\text{guide}}_g(t)$，日内调度：
\[
\min_{x_d\in\mathcal{X}_d(y)} \sum_{t\in\mathcal{T}} \big( p^{\text{guide}}_e(t)\,P_e(t) + p^{\text{guide}}_g(t)\,P_g(t) + c_{\text{shed}}\,L_{\text{shed}}(t) \big)
\]
其中 $\mathcal{X}_d(y)$ 是日内可行域（潮流、电/热/冷平衡、储能、设备容量上限等）。

---

## 3. 关键结论与可行性判据

### 结论 A：若“碳阈值必超标”，引导价可直接对齐 OJ 目标
若在当前 plan18 及其可行域下**全年排放必然超过阈值**，则
\[
\max(0, E_{\text{year}}-E_0) = E_{\text{year}}-E_0
\]
从而碳成本变为线性项：
\[
C_{\text{CO2}} = c_{\text{CO2}}\cdot E_{\text{year}} + \text{常数}
\]
该常数与决策无关，可忽略。此时把碳税并入电/气价即可：
\[
\boxed{p^{\text{guide}}_e(t) = p^*_e(t) + c_{\text{CO2}}\,\alpha_e(t)}
\]
\[
\boxed{p^{\text{guide}}_g(t) = p^*_g(t) + c_{\text{CO2}}\,\alpha_g(t)}
\]

**结论**：
- 在该条件下，日内调度的目标函数与 OJ 评分完全一致（差一个常数）。
- 对于**固定 plan18**，使用该引导价求得的日内解就是 OJ 口径的全局最优调度。
- 若全年按天解耦（储能日内闭环），分日并行求解得到的全年解即为全局最优调度。

### 结论 B：若规划层也参与优化，单层 MILP 可给出全局最优解
把规划变量 $y$ 与日内调度变量 $x_d$ 放入同一个 MILP：
\[
\min\; C_{\text{CAP}}(y) + \sum_d C_{\text{OP}}(x_d) + c_{\text{CO2}}\cdot E_{\text{year}}(x)
\]
\[
\text{s.t. } x_d \in \mathcal{X}_d(y),\; y\in\mathcal{Y}
\]
这就是当前 `run_full_milp.py` 所解的**单层 Monolithic MILP**。
当求解器给出很小的 MIPGap（例如 $<10^{-3}$），即为该模型意义下的**全局最优**或近似全局最优解。

---

## 4. 何时“引导价等价最优”不成立？

若出现以下任一情况，则**仅靠引导价无法保证全局最优**：

1. **碳阈值未必超标**
   - 若存在可行解使 $E_{\text{year}}\le E_0$，碳成本为 0；
   - 此时 OJ 目标含非线性拐点，不能用固定“加价”完全对齐。

2. **引导价被约束**
   - 如果引导价必须分时段常数、或倍数有上下界、或必须平滑，
     则无法严格等价于“真实价 + 碳税”。

3. **调度存在多解（退化）**
   - 即使目标系数对齐，仍可能有多个最优解。
   - 若你需要“上层最优”解（optimistic bilevel），
     需要在下层加词典序（lexicographic）或极小扰动来定解。

4. **跨日耦合**
   - 若储能跨日联动或存在年内全局约束，日内分解不再严格成立。

5. **计划层未优化**
   - 引导价对齐只保证**固定 plan18 下**的调度最优。
   - 想要“规划+调度”全局最优，必须求解单层 MILP 或使用精确分解（Benders/BBC）。

---

## 5. 结论（针对当前设定）

- **在“碳阈值必超标”的前提成立时**，引导电价/气价等价于将碳税内生化，
  对于固定 plan18，**可以得到 OJ 目标口径下的全局最优调度**。
- **若规划层也加入优化**，则应使用单层 MILP 直接求解，才能保证全局最优（或受 MIPGap 约束的近似最优）。
- 若未来发现排放并非必超标，或引导价存在硬约束/分段限制，则该等价性失效，需要回到显式双层或分解算法。

---

## 6. 建议的验证步骤
1. **最低排放可行性检验**：最小化排放，确认 $E_{\min} > E_0$。
2. **对齐价复算一致性**：用引导价与真实价+碳税两种口径计算成本，验证一致。
3. **多解稳定性**：引入词典序目标或微扰，保证调度解稳定。

如以上三步全部通过，可认为当前引导价方案在现有模型下达到了可证明的最优性。
