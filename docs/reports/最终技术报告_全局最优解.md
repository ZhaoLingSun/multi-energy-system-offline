# 全局最优解技术报告

## 0. 摘要
本报告覆盖从“评分口径校准 → 模型复现 → 两阶段优化 → 单层 MILP 全局最优求解”的完整过程，给出关键建模与编程细节、程序架构、最优性证明与主要调试记录。最终最优解由单层 Monolithic MILP 获得，并通过 OJ 评分复算精确对齐。

**最终最优结果**（full_milp_20260104_213903）：
- OJ 本地复算分数（最优解）：**88.88813770917979**
- gap=0 复核分数：**88.8847529920705**（略低，详见 `docs/reports/碳惩罚标准变化与gap0复核报告.md`）
- 结果文件：`runs/full_milp/full_milp_20260104_213903/da31/da3162413738b580_oj.csv`
- 汇总文件：`runs/full_milp/full_milp_20260104_213903/full_milp_summary.json`

**MEOS 平台最终导出验证**（删除平台 bug 导致的 ICE=1）：
- 平台文件：`meos/平台导出文件_最终.xls`
- OJ 提交文件：`output/platform_verify/平台导出文件_最终_oj.csv`
- 复算分数：**88.90147806255582**
- 关键成本：C_total=6.878924758e+08，C_OP=2.979635848e+08，C_Carbon=4.619969550e+07
- 排放：E_total=1.769994925e+05 tCO₂

---

## 1. 问题定义与目标

### 1.1 问题结构
- 三个能量枢纽：学生区、教工区、教学办公区。
- 决策分为两层：
  - **规划层（plan18）**：设备选型与容量（整数/连续）。
  - **运行层（日内调度）**：小时级运行与能量平衡。

### 1.2 优化目标
- **真实目标（OJ 口径）**：最小化年度总成本
  \[
  C_{total} = C_{CAP} + C_{OP} + C_{Carbon}
  \]
- OJ 最终分数：
  \[
  Score = \frac{100}{1 + \exp\big((C_{total}/cost\_unit - x_0)/k\big)}
  \]
- 所有常数与单位来自 `configs/oj_score.yaml`（冻结的 ScoreSpec）。

---

## 2. 数据与单位体系

### 2.1 数据输入
- 负荷曲线、电价、气价、碳因子、风光出力等：`data/raw/`
- 设备目录与容量映射：`spec/device_catalog.yaml`、`spec/plan18_map.yaml`
- OJ 评分规格：`configs/oj_score.yaml`

### 2.2 单位与口径
- 时间步长：1h
- 气量换算：**1 m³ = 0.01 MWh**
- 碳排放：电力 tCO₂/MWh，天然气 tCO₂/m³

---

## 3. 建模细节

### 3.1 规划层（plan18）
- 18 维向量表示设备配置（整数为台数/倍率）
- 风电/光伏直接按 MW 计（不乘基准容量）
- 设备基准容量与造价统一来自 `spec/device_catalog.yaml`

### 3.2 运行层（8760 小时调度）
日内变量包括：
- 火电出力、购气量、P2G、热泵、锅炉、冷机、储能充放、潮流、切负荷等。

能量平衡（以日内逐时为例）：
- 电、热、冷、气四张网均满足平衡
- 学生区/教工区/教学办公区分别平衡

### 3.3 储能分区建模（最新）
- 原“全局共享储能”改为**区域内独立建设/使用**。
- 新增整数变量 `storage_units[z, s]` 将 plan18 的 ES/HS/CS 台数分配到三大区。
- 每区储能进入本区电/热/冷平衡，并含 SOC 动态与互斥约束。

### 3.4 目标函数（MILP）
在 `carbon_mode=threshold` 下，MILP 目标为：
- **购电成本**：电价 × 火电出力
- **购气成本**：气价 × 购气量
- **失负荷惩罚**：500000 元/MWh
- **碳惩罚**：max(0, 年排放-阈值) × 600 元/tCO₂
- **CAPEX 年化成本**：基于设备寿命与贴现率

---

## 4. 程序架构

### 4.1 关键模块
- `scripts/run_full_milp.py`：单层 Monolithic MILP 主入口
- `meos/dispatch/zonal_dispatcher.py`：分区日内调度模型
- `meos/export/oj_exporter.py`：OJ CSV 输出
- `meos/simulate/annual_summary.py`：成本汇总与 Score 复算
- `scripts/score_oj_csv.py`：OJ 评分复算器（本地验证）

### 4.2 数据流
1. 读入原始数据（负荷、价格、碳因子）
2. 构建 MILP 并求解（Gurobi）
3. 导出 OJ CSV 与平台 CSV
4. 用 ScoreEngine 复算分数

---

## 5. 最优性证明

### 5.1 数学层面
- 单层 MILP 直接建模了“规划 + 全年运行 + 碳惩罚”
- Gurobi 分支定界 + 割平面算法提供 **全局最优性证书**

### 5.2 证书（最新结果）
`runs/full_milp/full_milp_20260104_213903/full_milp_summary.json`：
- 最优目标：`6.880951769524e+08`
- 最优下界：`6.880926826298e+08`
- MIPGap：`3.62e-06`

结论：该解在当前模型下**全局最优**（或可忽略误差的近似最优）；gap=0 复核未发现更优解。

---

## 6. 最终最优解摘要

### 6.1 plan18 与容量
- 学生区：CC_A 73（36.5 MW）、GSHP_B 2（20 MW）、PV 372 MW、P2G 324（162 MW）
- 教工区：CC_B 2（24 MW）、GSHP_A 9（18 MW）、GT 29（145 MW）
- 教学办公区：AC 5（60 MW）、GB 32（64 MW）、WT 362 MW、CCHP 11（33 MW）

### 6.2 储能分区
- 学生区：HS 10（400 MWh）、CS 7（280 MWh）
- 教工区：HS 10（400 MWh）
- 教学办公区：HS 4（160 MWh）、CS 24（960 MWh）

### 6.3 年度能量与排放
- 年购电量：214,261.05 MWh
- 年购气量：446,389.92 MWh（44,638,992.05 m³）
- 年碳排放：169,066.75 tCO₂

---

## 7. 关键调试与修复记录

1. **ScoreSpec 口径冻结**：确保所有常数只从 `oj_score.yaml` 读取。
2. **评分误差修复**：
   - 发现 `lifespan_years` 与 `lifespan` 字段不一致导致 C_CAP 偏大；
   - 修复后与 OJ 评分一致到 1e-11。
3. **风光单位对齐**：OJ 中风光 plan18 直接按 MW 计，模型端同步。
4. **储能互斥与日内 SOC**：确保充放互斥、SOC 日内闭环。
5. **储能分区建模**：新增加区域储能分配变量并进入平衡方程。
6. **远程调度稳定性**：修复同步脚本、日志监控、资源占用与线程配置。

---

## 8. 复现指南

**单层 MILP（本地）**
```bash
python scripts/run_full_milp.py \
  --days 365 --mip-gap 1e-5 --threads 64 \
  --carbon-mode threshold --relax-zero-bounds \
  --zero-bound-max 256 --upper-bound-scale 5 \
  --relax-from-summary runs/full_milp/full_milp_20260104_205257/full_milp_summary.json
```

**OJ 评分复算**
```bash
python scripts/score_oj_csv.py \
  runs/full_milp/full_milp_20260104_213903/da31/da3162413738b580_oj.csv
```

---

## 9. 结论
- 当前已得到可证明的全局最优解。
- 评分公式与 OJ 完全一致，误差已消除。
- 储能分区建模显著提升可行域与解质量。

如需进一步提高精度，可继续缩小 MIPGap 或进行结构化分解（Benders / BBC），但在当前资源与规模下已无必要。

---

## 10. 思考题技术路线与结果

### 10.1 建筑节能改造效益量化
**建模与编程**
- 将改造后热负荷视为现有数据曲线，通过强度比值 \(s=0.35/0.11\) 回推改造前负荷。
- 在调度模型中引入 `load_scale_heat`（默认 1.0，不影响主任务），固定 plan18 复算成本/排放。
- 脚本：`thought_questions/q1_retrofit/run_q1_retrofit.py`

**关键公式**
\[
L^{before}_{heat}(t)=L^{after}_{heat}(t)\cdot \frac{0.35}{0.11}
\]

**结果摘要**（详见 `docs/reports/思考题_01_建筑节能改造评估.md`）
- 成本下降：**3.487e11 元**（改造后 7.16 亿 vs 改造前 3494 亿）
- 碳排放下降：**5.32e4 tCO₂**（改造后 17.80 万吨 vs 改造前 23.13 万吨）
- 单位面积削减：**0.24 GJ/m²**

**物理意义**
- 需求侧削减直接降低供热侧能量与燃气消耗，改善系统峰谷与运行稳定性；在当前规划容量下，改造前负荷会触发高成本/切负荷惩罚。

### 10.2 跨季节冷热联储建模
**建模与编程**
- 以月尺度 LP 建模季节储能 SOC 动态，决策热/冷采购与跨季节转移。
- 脚本：`thought_questions/q2_seasonal_storage/run_q2_seasonal_storage.py`

**关键公式**
\[
S_{m+1}=(1-\lambda)S_m + \eta_{ch}Q^{ch}_m - \frac{1}{\eta_{dis}}Q^{dis}_m
\]

**结果摘要**（详见 `docs/reports/思考题_02_跨季节冷热联储评估.md`）
- 当前电/气月均价格波动较小，最优容量为 0，**经济性不足**。
- 季节性价格扰动（夏季电价×1.6、冬季气价×1.6）下，理论上限（CAPEX=0）可节约约 **1.459e7**。

**物理意义**
- 跨季节储能的核心收益来自季节性价差或弃能利用；在价格近似平坦时，其价值更多体现在“安全冗余”而非成本套利。

### 10.3 管道时间常数（线包）等效储能
**建模与编程**
- 以 `ans_gas` 作为气体需求序列，建立线包能量状态方程并最小化购气成本。
- 脚本：`thought_questions/q3_linepack/run_linepack_lp.py`

**关键公式**
\[
S_{t+1}=(1-\lambda)S_t + P^{buy}_t - D_t
\]

**结果摘要**（详见 `docs/reports/思考题_03_管道线包等效储能评估.md`）
- 在当前气价近似恒定的情况下，线包容量从 0~24h 对成本几乎无影响。
- 引入 0.3 的日内气价波动后，线包容量 6/12/24h 对应节约约 **9.73% / 16.24% / 23.67%**。

**物理意义**
- 线包的工程价值主要体现在削峰与保障供气连续性；若气价具备时变性或存在采购限额，其套利/削峰价值会显著提高。

### 10.4 分区规划与线路容量扩容
**建模与编程**
- 扫描电力线路容量，比较运行成本并引入扩容 CAPEX。
- 脚本：`thought_questions/q4_line_capacity/run_dispatch_scan.py`

**关键公式**
\[
|F_{ij}(t)| \le \bar{F}_{ij} + u_{ij},\quad C_{cap}=c_{ij}u_{ij}
\]

**结果摘要**（详见 `docs/reports/思考题_04_分区规划与线路扩容评估.md`）
- 容量 200/400/800 MW 的运行成本一致，扩容仅增加 CAPEX，**说明当前方案未受线路限制**。
- 热网传输容量降至 50 MW 时成本略升；≥200 MW 时影响消失，说明热网约束在较低容量才激活。

**物理意义**
- 当交换线路未构成瓶颈时，应优先本地消化；当负荷/供能结构变化导致约束激活时，扩容才具备经济性。

### 10.5 碳惩罚标准变化与松弛区判定
**建模与编程**
- 先求最低排放 \(E_{min}\) 并与阈值比较：若阈值 < \(E_{min}\)，松弛区不可行。
- 对多个阈值分别求解“松弛区/罚金区”两类 MILP，取成本更低者。
- 报告：`docs/reports/碳惩罚标准变化与gap0复核报告.md`

**结果摘要**
- \(E_{min} \approx 176{,}079\) tCO₂，远高于题设阈值 100,000 tCO₂。
- 阈值 ≤ 140,000 时松弛区不可行，只能进入罚金区。
- 阈值 180,000 时松弛区可行且略优于罚金区。

**物理意义**
- 当前系统在 plan18 固定下碳排放“刚性偏高”，碳阈值主要表现为线性罚金而非硬约束。

### 10.6 松弛区精确解策略验证
**要点**
- 将碳惩罚问题拆成“松弛区 MILP + 罚金区 MILP”，取更优解可得到精确解。
- 在阈值 180000 tCO₂ 下，松弛区解优于罚金区解且 \(E_{total}\) 恰好触阈值。
- 报告：`docs/reports/松弛区精确解策略验证.md`

**补充结论**
- 自动区模型的最优解落在松弛区与罚金区解之间，未优于松弛区解。
- 因此分段策略可作为“精确解”主方法，自动区可视为一致性校验。
